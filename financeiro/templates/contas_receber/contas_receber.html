{% extends "base.html" %}
{% load static %}
{% load tags %}
{% block datepicker %}
<script src ="{% static "tables/jquery.min.js" %}"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
{% endblock datepicker %}
{% block menu_li %}
<li class="nav-item">
  <a class="nav-link" href="{% url 'home' %}">
    <i class="material-icons">dashboard</i>
    <p>Dashboard</p>
  </a>
</li>
<li class="nav-item active  ">
  <a class="nav-link" href="#">
   <i class="material-icons">money</i>
   <p>Contas a receber</p>
 </a>
</li>
{% endblock menu_li %}
{% block container %}
<div class="content">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-12">
        <div class="card">
         <div class="card-header card-header-primary"data-background-color="purple">
          <h4 class="card-title ">Contas a Receber | Valor Total {{valor.total}} | Valor Espécie {{valor.especie}} | Valor Cartão {{valor.cartao}} <i  class=" material-icons collapsed pull-right" data-toggle="collapse" href="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">search</i></h4> 
        </div>
        <div class="card-content">
         <div id="collapseTwo" class="collapse" role="tabpanel" aria-labelledby="headingTwo" data-parent="#accordion" style="">
          <div class="card-body">
           <form method="GET"name="search">
            <div class="row">
              <div class="col-md-3 col-sm-3">
                <div class="form-group">
                  <input name="date_ranger"class="form-control"required>
                </div>
              </div>
              <div class="col-md-3 col-sm-3">
                <select class="selectpicker" name="profissional"data-style="select-with-transition" title="Profissional" data-size="7">
                  <option value="" selected>Profissional</option>
                  {% for p in pf %}
                  <option value="{{p.nome}}">{{p.nome}}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-3">
                <select class="selectpicker" name="status"data-style="select-with-transition" title="status" data-size="7">
                  <option value="" selected>Todos</option>
                  <option value="PD">Pendentes</option>
                  <option value="PG">Pagos</option>
                  <option value="FT">Faturados</option>
                  <option value="PC">Parcial</option>
                </select>
              </div>
              <div class="col-md-3">
                <select class="selectpicker" name="convenio"data-style="select-with-transition" title="convenio" data-size="7">
                  <option value="" selected>Convenio</option>
                  <option value="particular">Particular</option>
                  <option value="unimed">Unimed</option>
                  <option value="humanasaude">Humana Saúde</option>
                  <option value="saudecaixa">Saúde Caixa</option>
                  <option value="intermed">Intermed</option>
                  <option value="geapsaude">Geap Saúde</option>
                  <option value="fusma">Fusma</option>
                  <option value="cassi">Cassi</option>
                </select>
              </div>
            </div>
            <div class="row">
             <div class="col-md-3">
               <input type="text"class="form-control" name="paciente" placeholder="Nome do Paciente">
             </div>
             <div class="col-md-3">
              <select class="selectpicker" name="pagamento"data-style="select-with-transition" title="pagamento" data-size="7">
                <option value="" selected>Forma Pagamento</option>
                <option value="CV">Convênio</option>
                <option value="DI">Dinheiro</option>
                <option value="CC">Cartão de Crédito</option>
                <option value="EC">Dinheiro e Cartão</option>
                <option value="BB">Boleto bancário</option>
                <option value="TB">Transferência bancária</option>
              </select>
            </div>
            <div class="col-md-6 col-sm-1">
             <button type="submit" class="btn btn-primary pull-right btn-round"><i class="material-icons">search</i></button>
           </div>
         </div>
       </div>
     </form>
   </div>     
   <br>
   <table id="datatables" class="table table-striped table-no-bordered table-hover" cellspacing="0" width="100%" style="width:100%">
    <thead class=" text-primary">
      <th>Data</th>
      <th>Paciente</th>
      <th>Convenio</th>
      <th>F. Pagamento</th>
      <th>Valor Total</th>
      <th>Status</th>
      <th>$ Cartão</th>
      <th>$ Especie</th>
      <th>$ Saldo</th>
    </thead>
    <tbody>
      {% for c in contas %}
      <tr>
        <td>{{c.data|date:'d/m/Y'}}</td>
        <td>{{c.paciente}}</td>
        <td>{{c.convenio|upper}}</td>
        <td>
          {% if c.get_forma_pagamento_display == '' %}
          <b class="text-danger">--------</b>
          {% else %}
          <b class="text-info">{{c.get_forma_pagamento_display}}</b>
          {% endif %}
        </td>
        <td><b class="text-success">
          {% if request.user.is_superuser %}
            {{c.valor_total}}
          {% else %}
            {% if c.convenio.nome == 'particular' %}
              {{c.valor_total}}
            {% else %}
              --------------
            {% endif %}
          {% endif %}
        </b></td>
        <td>
         {% if c.status == 'PD' %}
         <b class="text-danger">{{c.get_status_display}}</b>
         {% elif c.status == 'PG' %}
         <b class="text-info">{{c.get_status_display}}</b>
         {% elif c.status == 'FT' %}
         <b class="text-info">{{c.get_status_display}}</b>
         {% elif c.status == 'PC' %}
         <b class="text-warning">{{c.get_status_display}}</b>
         {% endif %}
       </td>
       <td>
        {% if c.valor_pago_cartao%}
        {{c.valor_pago_cartao}}
        {% else %}
        {{c.procedimento}}
        {% endif %}
      </td>
      <td>
        {% if c.valor_pago_dinheiro %}
        {% if c.status == 'PC' %}
          {{c.valor_pago_dinheiro}}
        {% else %}
        {{c.valor_pago_dinheiro}}
        {% endif %}
        {% else %}
        {{c.valor_pago_dinheiro}}
        {% endif %}
      </td>
      <td>
        {% if c.valor_total|subtract:c.valor_pago_dinheiro > 0 %}
        <b class="text-warning">{{c.valor_total|subtract:c.valor_pago_dinheiro}}</b>
        {% else %}
        {{c.valor_total|subtract:c.valor_pago_dinheiro}}
        {% endif %}
      </td>
      <td> 
        {% if c.status == 'PD' or c.status == 'PC' %}
        <a href="{% url 'fazer_pagamento' c.id %}" title="Efetuar Pagamento"><i class="material-icons text-danger">monetization_on</i></a>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
</div><!-- end content-->
</div><!--  end card  -->
</div> <!-- end col-md-12 -->
</div> <!-- end row -->
</div>
</div>
<script type="text/javascript">
$('input[name="date_ranger"]').daterangepicker({
  "timePicker": false,
  "startDate": moment(),
  "endDate": moment(),
  "ranges": {
    'Hoje': [moment(), moment()],
    'Ontem': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
    'Ultimos 7 Dias': [moment().subtract(6, 'days'), moment()],
    'Ultimos 30 Dias': [moment().subtract(29, 'days'), moment()],
    'Esse Mês': [moment().startOf('month'), moment().endOf('month')],
    'Último Mês': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
  },
  showDropdowns: true,
  "locale": {
    "format": "DD/MM/YYYY",
    "separator": " / ",
    "applyLabel": "Aplicar",
    "cancelLabel": "Cancelar",
    "fromLabel": "De",
    "toLabel": "Até",
    "customRangeLabel": "Customizado",
    "daysOfWeek": [
    "Dom",
    "Seg",
    "Ter",
    "Qua",
    "Qui",
    "Sex",
    "Sáb"
    ],
    "monthNames": [
    "Janeiro",
    "Fevereiro",
    "Março",
    "Abril",
    "Maio",
    "Junho",
    "Julho",
    "Agosto",
    "Setembro",
    "Outubro",
    "Novembro",
    "Dezembro"
    ],
    "firstDay": 0
  }
}, function(start, end, label) {
  console.log("New date range selected: ' + start.format('YYYY-MM-DD') + ' to ' + end.format('YYYY-MM-DD') + ' (predefined range: ' + label + ')");

});
$(document).ready(function() {
  $('#datatables').DataTable({
    "pagingType": "full_numbers",
    "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
    responsive: true,
    searching: false, 
    "language": {
      "sProcessing":   "Processando...",
      "sLengthMenu":   " _MENU_ ",
      "sZeroRecords":  "<b><center>Não foram encontrados resultados</center><b>",
      "info": "Pág _PAGE_ de _PAGES_",
      "sInfoEmpty":    "",
      "sInfoFiltered": "",
      "sInfoPostFix":  "",
      "sSearch":       "Busca",
      "sUrl":          "",
      "oPaginate": {
        "sFirst":    "Primeiro",
        "sPrevious": "",
        "sNext":     "",
        "sLast":     "Último"
      }
    }
  });


  var table = $('#datatables').DataTable();

    // Edit record
    table.on( 'click', '.edit', function () {
      $tr = $(this).closest('tr');

      var data = table.row($tr).data();
      alert( 'You press on Row: ' + data[0] + ' ' + data[1] + ' ' + data[2] + '\'s row.' );
    } );

    // Delete a record
    table.on( 'click', '.remove', function (e) {
      $tr = $(this).closest('tr');
      table.row($tr).remove().draw();
      e.preventDefault();
    } );

    //Like record
    table.on( 'click', '.like', function () {
      alert('You clicked on Like button');
    });

    $('.card .material-datatables label').addClass('form-group');
  });

</script>
{% endblock container %}
